name: Publicar dados no CKAN (dados.mg.gov.br)

on:
  push:
    branches: [ main ]
    paths:
      - 'data/**'
      - 'datapackage/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  publish_ckan:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4

      - name: Instalar jq
        run: sudo apt-get install -y jq

      - name: Gerar datapackage.json
        run: python scripts/gerar_datapackage.py

      - name: Commit datapackage.json
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Atualiza datapackage.json automaticamente
          file_pattern: datapackage/datapackage.json

      - name: Publicar recursos no CKAN (N anos autom√°tico)
        env:
          CKAN_KEY: ${{ secrets.CKAN_KEY }}
          CKAN_HOST: https://www.dados.mg.gov.br
          DATASET: empregados-terceirizados-mg
        run: |
          set -e

          echo "Lendo datapackage.json"
          RESOURCES=$(jq -c '.resources[]' datapackage/datapackage.json)

          for res in $RESOURCES; do
            NAME=$(echo "$res" | jq -r '.name')
            TITLE=$(echo "$res" | jq -r '.title')
            PATH=$(echo "$res" | jq -r '.path')
            DESC=$(echo "$res" | jq -r '.description')

            URL="https://raw.githubusercontent.com/${{ github.repository }}/main/${PATH}"

            echo "‚û°Ô∏è Processando recurso: $NAME"

            SEARCH=$(curl -s -X POST "$CKAN_HOST/api/3/action/resource_search" \
              -H "Authorization: $CKAN_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"query\":\"name:$NAME\",\"package_id\":\"$DATASET\"}")

            COUNT=$(echo "$SEARCH" | jq '.result.count')

            if [ "$COUNT" -gt 0 ]; then
              ID=$(echo "$SEARCH" | jq -r '.result.results[0].id')
              ACTION="resource_update"
              EXTRA=", \"id\": \"$ID\""
              echo "üîÑ Atualizando recurso existente"
            else
              ACTION="resource_create"
              EXTRA=""
              echo "üÜï Criando novo recurso"
            fi

            curl -s -X POST "$CKAN_HOST/api/3/action/$ACTION" \
              -H "Authorization: $CKAN_KEY" \
              -H "Content-Type: application/json" \
              -d "{
                \"package_id\": \"$DATASET\",
                \"name\": \"$NAME\",
                \"title\": \"$TITLE\",
                \"url\": \"$URL\",
                \"url_type\": \"link\",
                \"format\": \"CSV\",
                \"description\": \"$DESC\"
                $EXTRA
              }"
          done

          echo "‚úÖ Publica√ß√£o CKAN finalizada"
